{"ast":null,"code":"/* eslint-disable no-unused-expressions */\nimport { Layer } from './Layer';\nimport { Text } from './../2DObjects/Text';\nimport RenderManager from '../rendering/render-manager';\nexport default class LayersManager {\n  constructor(data) {\n    this.container = document.createElement('div');\n    this.container.id = 'slide-layers-container';\n    this.container.style.background = window.Q3.data.slides[0].background || '#fff';\n    this.container.style.position = 'relative';\n    this.container.style.height = '100%';\n\n    if (!window.Q3.editMode) {\n      this.letterbox = window.Q3.letterbox;\n    }\n\n    this.attachedObjects = [];\n    this.hoverDependentObjects = []; //to find layers by uuid as in data\n\n    this.list = {}; //The stack stores every layers,\n    //even ones removed from the container (unvisible).\n    //Purpose = keep track of indices and parenting\n\n    this.graph = []; //output list without parenting and groups\n\n    this.stack = []; //init\n\n    this.list['Renderer'] = new Layer({\n      name: data.layers.layer3D.name,\n      index: 0,\n      visible: data.slides[0].layers.Renderer,\n      parent: data.layers.layer3D.parent,\n      domElement: RenderManager.domElement,\n      uuid: 'Renderer',\n      type: 'Renderer'\n    });\n    let objFolders = [{\n      name: 'texts',\n      folderName: 'Texts'\n    }, {\n      name: 'mathFormulas',\n      folderName: 'Math Formulas'\n    }, {\n      name: 'buttons',\n      folderName: 'Buttons'\n    }, {\n      name: 'sliders',\n      folderName: 'Sliders'\n    }, {\n      name: 'circleSliders',\n      folderName: 'CircleSliders'\n    }, {\n      name: 'lines',\n      folderName: 'Lines'\n    }, {\n      name: 'iframes',\n      folderName: 'Iframes'\n    }, {\n      name: 'pictures',\n      folderName: 'Pictures'\n    }, {\n      name: 'liveLabels',\n      folderName: 'LiveLabels'\n    }];\n    objFolders.forEach(f => {\n      this[f.name] = new Layer({\n        name: f.folderName,\n        type: '2DGroup',\n        visible: true\n      });\n      this.list[this[f.name].uuid] = this[f.name];\n      this[f.name].isRootFolder = true;\n      window.Q3.data.slides.forEach(s => {\n        s.layers[this[f.name].uuid] = true;\n      });\n    });\n    let layers2d = {};\n\n    for (let uuid in window.Q3.data.layers.layers2D) {\n      if (window.Q3.data.slides[0].layers2D[uuid] || window.Q3.data.layers.layers2D[uuid].generalVisibility) {\n        layers2d[uuid] = window.Q3.data.layers.layers2D[uuid];\n      }\n    }\n\n    this.addLayers(layers2d);\n    this.updateGraph();\n    this.updateStack();\n    this.updateLayersRender();\n    window.Q3.container.appendChild(this.container);\n    return this;\n  }\n\n  addLayers(data) {\n    for (let uuid in data) {\n      const layerData = data[uuid];\n\n      if (!layerData.objects) {\n        console.warn('Found Layer 2D with \"objects\" property not set, it will be removed');\n        layerData.objects = {};\n      }\n\n      const key = Object.keys(layerData.objects)[0];\n\n      if (!key) {\n        delete data[uuid];\n        continue;\n      }\n\n      if (layerData.objects[key].type === 'iframe') {\n        layerData.subtype = 'iframes';\n      }\n\n      this.list[uuid] = new Layer({\n        type: layerData.type,\n        isText: layerData.objects[key].type === 'text' || layerData.objects[key].type === 'mathFormula',\n        uuid: uuid,\n        name: layerData.name,\n        // index: index,\n        visible: true,\n        generalVisibility: layerData.generalVisibility,\n        parent: layerData.parent,\n        objects: layerData.objects,\n        subtype: layerData.subtype\n      });\n\n      if (layerData.templateId && layerData.templateUuid) {\n        this.list[uuid].templateId = layerData.templateId;\n        this.list[uuid].templateUuid = layerData.templateUuid;\n      }\n\n      this.list[uuid].level = 1;\n\n      if (layerData.objects[key].type === 'text') {\n        this.list[uuid].parent = this.texts.uuid;\n      }\n\n      if (layerData.objects[key].type === 'mathFormula') {\n        this.list[uuid].parent = this.mathFormulas.uuid;\n      }\n\n      if (layerData.objects[key].type === 'button') {\n        this.list[uuid].parent = this.buttons.uuid;\n      }\n\n      if (layerData.objects[key].type === 'slider') {\n        this.list[uuid].parent = this.sliders.uuid;\n      }\n\n      if (layerData.objects[key].type === 'circleSlider') {\n        this.list[uuid].parent = this.circleSliders.uuid;\n      }\n\n      if (layerData.objects[key].type === 'line') {\n        this.list[uuid].parent = this.lines.uuid;\n      }\n\n      if (layerData.objects[key].type === 'picture') {\n        this.list[uuid].parent = this.pictures.uuid;\n      }\n\n      if (layerData.objects[key].type === 'iframe') {\n        this.list[uuid].parent = this.iframes.uuid;\n      }\n    }\n  }\n\n  update(slide, byScroll) {\n    this.updateGraph();\n    this.updateStack();\n    this.updateLayersRender(slide, byScroll);\n  }\n\n  updateChildrenIndices(childrenArray) {// let i = 0;\n    // childrenArray.forEach( (c) => {\n    //   c.index = i;\n    //   c.uuid === 'Renderer' ?\n    //     window.Q3.data.layers.layer3D.index = i\n    //     : window.Q3.data.layers.layers2D[c.uuid].index = i;\n    //   i++;\n    // })\n  }\n\n  updateGraph() {\n    //reset graph\n    this.graph = []; //reset parenting\n    // for (let layer in this.list)\n\n    let generalVisibility = [];\n    this.texts.children && this.texts.children.forEach(t => {\n      t.generalVisibility && window.Q3.data.layers.layers2D[t.uuid] && generalVisibility.push(t);\n    });\n    Object.keys(this.list).forEach(uuid => {\n      //reset parenting\n      if (this.list[uuid].children) {\n        this.list[uuid].children = [];\n      } //check current visibilities\n\n\n      this.list[uuid].visible = window.Q3.data.slides[window.Q3.slide].layers[uuid];\n    });\n    this.texts.children = generalVisibility; //create new graph\n\n    Object.keys(this.list).forEach(uuid => {\n      const layer = this.list[uuid];\n\n      if (layer.parent) {\n        const parentPlayer = this.list[layer.parent];\n\n        if (parentPlayer) {\n          parentPlayer.add(layer);\n          layer.isVisible = parentPlayer.isVisible;\n        }\n      } else this.graph[this.graph.length] = layer;\n    });\n  }\n\n  updateStack() {\n    this.stack = []; //update levels + build stack\n\n    const traverseLevels = (a, level = 0) => {\n      for (let i = 0; i < a.length; i++) {\n        if (!a[i]) continue;\n        a[i].level = level;\n        if (!a[i].visible) continue;\n        if (a[i].type === '2DGroup') traverseLevels(a[i].children, level + 1);else {\n          if (this.stack.indexOf(a[i]) === -1) this.stack.push(a[i]);\n        }\n      }\n    };\n\n    traverseLevels(this.graph);\n  }\n\n  updateLayersRender(slide, byScroll) {\n    if (slide && slide === window.Q3.slide) {\n      while (this.container.lastChild) this.container.removeChild(this.container.lastChild);\n\n      if (this.letterbox) {\n        this.letterbox.innerHTML = '';\n      }\n\n      this.stack.forEach(layer => {\n        this.container.appendChild(layer.domElement);\n      });\n    } else {\n      let layersToKeep = []; //browser DOM rendering efficiency here ?\n\n      this.stack.forEach(layer => {\n        if (layer.objects && layer.objects[0] instanceof Text) {\n          // if (window.Q3.slide !== 0 && window.Q3.data.slides[window.Q3.prevSlide] && window.Q3.data.slides[window.Q3.prevSlide].layers[layer.uuid]) { layersToKeep.push(layer.domElement.id); }\n          if (layer.generalVisibility) {\n            layersToKeep.push(layer.domElement.id);\n          }\n        }\n      });\n      [...['container'], ...(this.letterbox ? ['letterbox'] : [])].forEach(cnt => {\n        const children = this[cnt].children;\n        const childrenArray = Array.prototype.slice.call(children);\n        childrenArray.forEach(child => {\n          if (child.id !== '' && layersToKeep.indexOf(child.id) > -1) ;else if (!child.classList.contains('has-leaving-animation')) this[cnt].removeChild(child);\n        });\n      });\n      this.stack.forEach(layer => {\n        if (layer.objects && layer.objects[0] instanceof Text && !window.Q3.editMode) {\n          if (window.Q3.slide !== 0 && window.Q3.data.slides[window.Q3.prevSlide] && window.Q3.data.slides[window.Q3.prevSlide].layers[layer.uuid]) {} else {\n            let targetCnt = this[layer.objects[0].targetUuid ? 'container' : 'letterbox'];\n            !targetCnt.contains(layer.domElement) && targetCnt.appendChild(layer.domElement);\n          }\n\n          window.Q3.scrollPositions = window.Q3.scrollPositions || [];\n          let el = layer.objects[0].domElement.children[0].children[0];\n\n          if (!window.Q3.scrollPositions[layer.objects[0].uuid] && !layer.generalVisibility) {\n            setScrollPositions(el, layer.objects[0].startSlide, layer.objects[0].uuid);\n          }\n\n          const scrollPositions = window.Q3.scrollPositions[layer.objects[0].uuid];\n\n          if (scrollPositions) {\n            const scrollTop = window.Q3.scrollPositions[layer.objects[0].uuid][window.Q3.slide];\n            scrollTop !== -1 && !byScroll ? el.scrollTop = scrollTop : null;\n          }\n        } else if (layer.objects && (layer.objects[0] instanceof window.Q3.Picture || layer.objects[0] instanceof window.Q3.Button || layer.objects[0] instanceof window.Q3.Iframe) && !window.Q3.editMode) {\n          this.letterbox.appendChild(layer.domElement);\n        } else {\n          this.container.appendChild(layer.domElement);\n        }\n      });\n    } //browser DOM rendering efficiency here ?\n\n    /*  while ( this.container.lastChild ) this.container.removeChild( this.container.lastChild );\n        this.stack.forEach( layer => { this.container.appendChild( layer.domElement ) } );*/\n\n  }\n\n  render() {\n    let w = RenderManager.domElement.width;\n    let h = RenderManager.domElement.height - 55; // if (w<=768 && !window.Q3.editMode) {\n    //   h = h - 50;\n    // }\n\n    this.graph.forEach(layer => layer.render(w / window.devicePixelRatio, h / window.devicePixelRatio));\n    this.occludeObjects();\n  }\n\n  occludeObjects() {\n    //todo :\n    //before checking what object occludes what other object\n    //check if objects are occluded by other stuff\n    //which means first cpu calculcation of distance and comparing to depthbbuffer.\n    if (!window.Q3.depthPass || window.Q3.noFragDepth || window.Q3.noDepthTex) return; //1. get camera distance and depth value\n\n    this.attachedObjects.forEach(object => {\n      if (object instanceof window.Q3.Text) {\n        const x = parseInt(object.domElement.getAttribute('x')),\n              y = parseInt(object.domElement.getAttribute('y')),\n              width = parseInt(object.textElement.style.width),\n              height = parseInt(object.textElement.style.height),\n              cx = x + width / 2,\n              cy = y + height / 2; //Units = far-near distance\n        //1. depth value at the position of the target ( to check object occlusion)\n\n        object.depthValue = window.Q3.depthPass.getDepthRatio(cx, cy); //2. camera distance of the target\n\n        object.camDist = (object.target.position.clone().sub(window.Q3.camera.position).length() - window.Q3.camera.near) / (window.Q3.camera.far - window.Q3.camera.near);\n      } else if (object instanceof window.Q3.Picture) {\n        const x = parseInt(object.domElement.getAttribute('x')),\n              y = parseInt(object.domElement.getAttribute('y')),\n              width = parseInt(object.pictureElement.style.width),\n              height = parseInt(object.pictureElement.style.height) || 0.5,\n              cx = x + width / 2,\n              cy = y + height / 2; //Units = far-near distance\n        //1. depth value at the position of the target ( to check object occlusion)\n\n        object.depthValue = window.Q3.depthPass.getDepthRatio(cx, cy); //2. camera distance of the target\n\n        object.camDist = (object.target.position.clone().sub(window.Q3.camera.position).length() - window.Q3.camera.near) / (window.Q3.camera.far - window.Q3.camera.near);\n      }\n    }); //2. sort on camera distance\n\n    this.attachedObjects.sort((a, b) => {\n      return a.camDist < b.camDist ? -1 : a.camDist > b.camDist ? 1 : 0;\n    }); //3. object occlusion\n\n    const visibleObjects = [];\n    this.attachedObjects.forEach(object => {\n      if (!object.depthOccluded) {\n        object.show();\n        visibleObjects.push(object);\n        return;\n      }\n\n      if (object.depthValue < object.camDist) {\n        object.hide();\n      } else {\n        object.show();\n        visibleObjects.push(object);\n      }\n    }); //4. occlude by checking previous objects\n\n    visibleObjects.forEach((object, i) => {\n      if (i === 0) return object.show();\n      if (!object.elementsOccluded) return object.show();\n\n      for (let j = 0; j < i; j++) {\n        if (areColliding(this.attachedObjects[j], object)) {\n          return object.hide();\n        }\n      }\n\n      object.show();\n    });\n  }\n\n}\n\nfunction areColliding(objectA, objectB) {\n  const xA = parseInt(objectA.domElement.getAttribute('x')),\n        yA = parseInt(objectA.domElement.getAttribute('y')),\n        widthA = parseInt(objectA.textElement.style.width),\n        heightA = parseInt(objectA.textElement.style.height),\n        xB = parseInt(objectB.domElement.getAttribute('x')),\n        yB = parseInt(objectB.domElement.getAttribute('y')),\n        widthB = parseInt(objectB.textElement.style.width),\n        heightB = parseInt(objectB.textElement.style.height);\n  let areCollidingHorizontally = false,\n      areCollidingVertically = false; //horizontal checks\n\n  if (xA > xB) areCollidingHorizontally = xB + widthB > xA;else if (xA < xB) areCollidingHorizontally = xA + widthA > xB; //vertical checks\n\n  if (yA > yB) areCollidingVertically = yB + heightB > yA;else if (yA < yB) areCollidingVertically = yA + heightA > yB;\n  return areCollidingHorizontally && areCollidingVertically;\n}\n\nfunction setScrollPositions(el, startSlide, uuid) {\n  let scrollPositions = [];\n\n  for (let i in window.Q3.data.slides) {\n    scrollPositions[i] = -1;\n  }\n\n  scrollPositions[startSlide] = 0;\n  const textElementTop = el.getBoundingClientRect().top;\n  el.innerHTML += '<hr class=\"horizontal-marker viewer\"></hr>';\n  const markers = $(el).find('.horizontal-marker');\n  let slide = startSlide + 1;\n  let shouldSet = true;\n\n  if (markers.length > 1) {\n    for (var i = 0; i < markers.length; i++) {\n      //this.options.scrollPositions[$(markers[i]).attr('data-slide')] = Math.round(markers[i].getBoundingClientRect().top - textElementTop);\n      console.log(markers[i].getBoundingClientRect().top);\n      if (markers[i].getBoundingClientRect().top === 0) shouldSet = false;\n      scrollPositions[slide++] = Math.round(markers[i].getBoundingClientRect().top - textElementTop);\n    }\n  }\n\n  window.Q3.scrollPositions = window.Q3.scrollPositions || [];\n  if (shouldSet) window.Q3.scrollPositions[uuid] = scrollPositions;\n} // WEBPACK FOOTER //\n// ./src/Q3/layers/LayersManager.js","map":{"version":3,"sources":["/Users/ghost/Documents/three/src/source/layers/LayersManager.js"],"names":["Layer","Text","RenderManager","LayersManager","constructor","data","container","document","createElement","id","style","background","window","Q3","slides","position","height","editMode","letterbox","attachedObjects","hoverDependentObjects","list","graph","stack","name","layers","layer3D","index","visible","Renderer","parent","domElement","uuid","type","objFolders","folderName","forEach","f","isRootFolder","s","layers2d","layers2D","generalVisibility","addLayers","updateGraph","updateStack","updateLayersRender","appendChild","layerData","objects","console","warn","key","Object","keys","subtype","isText","templateId","templateUuid","level","texts","mathFormulas","buttons","sliders","circleSliders","lines","pictures","iframes","update","slide","byScroll","updateChildrenIndices","childrenArray","children","t","push","layer","parentPlayer","add","isVisible","length","traverseLevels","a","i","indexOf","lastChild","removeChild","innerHTML","layersToKeep","cnt","Array","prototype","slice","call","child","classList","contains","prevSlide","targetCnt","targetUuid","scrollPositions","el","setScrollPositions","startSlide","scrollTop","Picture","Button","Iframe","render","w","width","h","devicePixelRatio","occludeObjects","depthPass","noFragDepth","noDepthTex","object","x","parseInt","getAttribute","y","textElement","cx","cy","depthValue","getDepthRatio","camDist","target","clone","sub","camera","near","far","pictureElement","sort","b","visibleObjects","depthOccluded","show","hide","elementsOccluded","j","areColliding","objectA","objectB","xA","yA","widthA","heightA","xB","yB","widthB","heightB","areCollidingHorizontally","areCollidingVertically","textElementTop","getBoundingClientRect","top","markers","$","find","shouldSet","log","Math","round"],"mappings":"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","sourcesContent":["/* eslint-disable no-unused-expressions */\nimport { Layer } from './Layer';\nimport { Text } from './../2DObjects/Text';\nimport RenderManager from '../rendering/render-manager';\n\nexport default class LayersManager {\n\tconstructor(data) {\n\t\tthis.container = document.createElement('div');\n\t\tthis.container.id = 'slide-layers-container';\n\t\tthis.container.style.background = window.Q3.data.slides[0].background || '#fff';\n\t\tthis.container.style.position = 'relative';\n\t\tthis.container.style.height = '100%';\n\t\tif (!window.Q3.editMode) {\n\t\t\tthis.letterbox = window.Q3.letterbox;\n\t\t}\n\n\t\tthis.attachedObjects = [];\n\n\t\tthis.hoverDependentObjects = [];\n\n\t\t//to find layers by uuid as in data\n\t\tthis.list = {};\n\n\t\t//The stack stores every layers,\n\t\t//even ones removed from the container (unvisible).\n\t\t//Purpose = keep track of indices and parenting\n\t\tthis.graph = [];\n\n\t\t//output list without parenting and groups\n\t\tthis.stack = [];\n\n\t\t//init\n\t\tthis.list['Renderer'] = new Layer({\n\t\t\tname: data.layers.layer3D.name,\n\t\t\tindex: 0,\n\t\t\tvisible: data.slides[0].layers.Renderer,\n\t\t\tparent: data.layers.layer3D.parent,\n\t\t\tdomElement: RenderManager.domElement,\n\t\t\tuuid: 'Renderer',\n\t\t\ttype: 'Renderer'\n\t\t});\n\n\t\tlet objFolders = [\n\t\t\t{\n\t\t\t\tname: 'texts',\n\t\t\t\tfolderName: 'Texts'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'mathFormulas',\n\t\t\t\tfolderName: 'Math Formulas'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'buttons',\n\t\t\t\tfolderName: 'Buttons'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'sliders',\n\t\t\t\tfolderName: 'Sliders'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'circleSliders',\n\t\t\t\tfolderName: 'CircleSliders'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'lines',\n\t\t\t\tfolderName: 'Lines'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'iframes',\n\t\t\t\tfolderName: 'Iframes'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'pictures',\n\t\t\t\tfolderName: 'Pictures'\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'liveLabels',\n\t\t\t\tfolderName: 'LiveLabels'\n\t\t\t}\n\t\t];\n\n\t\tobjFolders.forEach(f => {\n\t\t\tthis[f.name] = new Layer({\n\t\t\t\tname: f.folderName,\n\t\t\t\ttype: '2DGroup',\n\t\t\t\tvisible: true\n\t\t\t});\n\t\t\tthis.list[this[f.name].uuid] = this[f.name];\n\t\t\tthis[f.name].isRootFolder = true;\n\t\t\twindow.Q3.data.slides.forEach(s => {\n\t\t\t\ts.layers[this[f.name].uuid] = true;\n\t\t\t});\n\t\t});\n\n\t\tlet layers2d = {};\n\t\tfor (let uuid in window.Q3.data.layers.layers2D) {\n\t\t\tif (window.Q3.data.slides[0].layers2D[uuid] || window.Q3.data.layers.layers2D[uuid].generalVisibility) {\n\t\t\t\tlayers2d[uuid] = window.Q3.data.layers.layers2D[uuid];\n\t\t\t}\n\t\t}\n\t\tthis.addLayers(layers2d);\n\n\t\tthis.updateGraph();\n\n\t\tthis.updateStack();\n\n\t\tthis.updateLayersRender();\n\n\t\twindow.Q3.container.appendChild(this.container);\n\n\t\treturn this;\n\t}\n\n\taddLayers(data) {\n\t\tfor (let uuid in data) {\n\t\t\tconst layerData = data[uuid];\n\t\t\tif (!layerData.objects) {\n\t\t\t\tconsole.warn('Found Layer 2D with \"objects\" property not set, it will be removed');\n\t\t\t\tlayerData.objects = {};\n\t\t\t}\n\n\t\t\tconst key = Object.keys(layerData.objects)[0];\n\t\t\tif (!key) {\n\t\t\t\tdelete data[uuid];\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'iframe') {\n\t\t\t\tlayerData.subtype = 'iframes';\n\t\t\t}\n\t\t\tthis.list[uuid] = new Layer({\n\t\t\t\ttype: layerData.type,\n\t\t\t\tisText: layerData.objects[key].type === 'text' || layerData.objects[key].type === 'mathFormula',\n\t\t\t\tuuid: uuid,\n\t\t\t\tname: layerData.name,\n\t\t\t\t// index: index,\n\t\t\t\tvisible: true,\n\t\t\t\tgeneralVisibility: layerData.generalVisibility,\n\t\t\t\tparent: layerData.parent,\n\t\t\t\tobjects: layerData.objects,\n\t\t\t\tsubtype: layerData.subtype\n\t\t\t});\n\t\t\tif (layerData.templateId && layerData.templateUuid) {\n\t\t\t\tthis.list[uuid].templateId = layerData.templateId;\n\t\t\t\tthis.list[uuid].templateUuid = layerData.templateUuid;\n\t\t\t}\n\t\t\tthis.list[uuid].level = 1;\n\t\t\tif (layerData.objects[key].type === 'text') {\n\t\t\t\tthis.list[uuid].parent = this.texts.uuid;\n\t\t\t}\n\n\t\t\tif (layerData.objects[key].type === 'mathFormula') {\n\t\t\t\tthis.list[uuid].parent = this.mathFormulas.uuid;\n\t\t\t}\n\n\t\t\tif (layerData.objects[key].type === 'button') {\n\t\t\t\tthis.list[uuid].parent = this.buttons.uuid;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'slider') {\n\t\t\t\tthis.list[uuid].parent = this.sliders.uuid;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'circleSlider') {\n\t\t\t\tthis.list[uuid].parent = this.circleSliders.uuid;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'line') {\n\t\t\t\tthis.list[uuid].parent = this.lines.uuid;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'picture') {\n\t\t\t\tthis.list[uuid].parent = this.pictures.uuid;\n\t\t\t}\n\t\t\tif (layerData.objects[key].type === 'iframe') {\n\t\t\t\tthis.list[uuid].parent = this.iframes.uuid;\n\t\t\t}\n\t\t}\n\t}\n\n\tupdate(slide, byScroll) {\n\t\tthis.updateGraph();\n\t\tthis.updateStack();\n\t\tthis.updateLayersRender(slide, byScroll);\n\t}\n\n\tupdateChildrenIndices(childrenArray) {\n\t\t// let i = 0;\n\t\t// childrenArray.forEach( (c) => {\n\t\t//   c.index = i;\n\t\t//   c.uuid === 'Renderer' ?\n\t\t//     window.Q3.data.layers.layer3D.index = i\n\t\t//     : window.Q3.data.layers.layers2D[c.uuid].index = i;\n\t\t//   i++;\n\t\t// })\n\t}\n\n\tupdateGraph() {\n\t\t//reset graph\n\t\tthis.graph = [];\n\n\t\t//reset parenting\n\t\t// for (let layer in this.list)\n\n\t\tlet generalVisibility = [];\n\n\t\tthis.texts.children &&\n\t\t\tthis.texts.children.forEach(t => {\n\t\t\t\tt.generalVisibility && window.Q3.data.layers.layers2D[t.uuid] && generalVisibility.push(t);\n\t\t\t});\n\n\t\tObject.keys(this.list).forEach(uuid => {\n\t\t\t//reset parenting\n\t\t\tif (this.list[uuid].children) {\n\t\t\t\tthis.list[uuid].children = [];\n\t\t\t}\n\n\t\t\t//check current visibilities\n\t\t\tthis.list[uuid].visible = window.Q3.data.slides[window.Q3.slide].layers[uuid];\n\t\t});\n\n\t\tthis.texts.children = generalVisibility;\n\n\t\t//create new graph\n\t\tObject.keys(this.list).forEach(uuid => {\n\t\t\tconst layer = this.list[uuid];\n\n\t\t\tif (layer.parent) {\n\t\t\t\tconst parentPlayer = this.list[layer.parent];\n\t\t\t\tif (parentPlayer) {\n\t\t\t\t\tparentPlayer.add(layer);\n\t\t\t\t\tlayer.isVisible = parentPlayer.isVisible;\n\t\t\t\t}\n\t\t\t} else this.graph[this.graph.length] = layer;\n\t\t});\n\t}\n\n\tupdateStack() {\n\t\tthis.stack = [];\n\n\t\t//update levels + build stack\n\t\tconst traverseLevels = (a, level = 0) => {\n\t\t\tfor (let i = 0; i < a.length; i++) {\n\t\t\t\tif (!a[i]) continue;\n\t\t\t\ta[i].level = level;\n\t\t\t\tif (!a[i].visible) continue;\n\t\t\t\tif (a[i].type === '2DGroup') traverseLevels(a[i].children, level + 1);\n\t\t\t\telse {\n\t\t\t\t\tif (this.stack.indexOf(a[i]) === -1) this.stack.push(a[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\ttraverseLevels(this.graph);\n\t}\n\n\tupdateLayersRender(slide, byScroll) {\n\t\tif (slide && slide === window.Q3.slide) {\n\t\t\twhile (this.container.lastChild) this.container.removeChild(this.container.lastChild);\n\t\t\tif (this.letterbox) {\n\t\t\t\tthis.letterbox.innerHTML = '';\n\t\t\t}\n\t\t\tthis.stack.forEach(layer => {\n\t\t\t\tthis.container.appendChild(layer.domElement);\n\t\t\t});\n\t\t} else {\n\t\t\tlet layersToKeep = [];\n\t\t\t//browser DOM rendering efficiency here ?\n\n\t\t\tthis.stack.forEach(layer => {\n\t\t\t\tif (layer.objects && layer.objects[0] instanceof Text) {\n\t\t\t\t\t// if (window.Q3.slide !== 0 && window.Q3.data.slides[window.Q3.prevSlide] && window.Q3.data.slides[window.Q3.prevSlide].layers[layer.uuid]) { layersToKeep.push(layer.domElement.id); }\n\t\t\t\t\tif (layer.generalVisibility) {\n\t\t\t\t\t\tlayersToKeep.push(layer.domElement.id);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t[...['container'], ...(this.letterbox ? ['letterbox'] : [])].forEach(cnt => {\n\t\t\t\tconst children = this[cnt].children;\n\t\t\t\tconst childrenArray = Array.prototype.slice.call(children);\n\n\t\t\t\tchildrenArray.forEach(child => {\n\t\t\t\t\tif (child.id !== '' && layersToKeep.indexOf(child.id) > -1);\n\t\t\t\t\telse if (!child.classList.contains('has-leaving-animation')) this[cnt].removeChild(child);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.stack.forEach(layer => {\n\t\t\t\tif (layer.objects && layer.objects[0] instanceof Text && !window.Q3.editMode) {\n\t\t\t\t\tif (\n\t\t\t\t\t\twindow.Q3.slide !== 0 &&\n\t\t\t\t\t\twindow.Q3.data.slides[window.Q3.prevSlide] &&\n\t\t\t\t\t\twindow.Q3.data.slides[window.Q3.prevSlide].layers[layer.uuid]\n\t\t\t\t\t) {\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet targetCnt = this[layer.objects[0].targetUuid ? 'container' : 'letterbox'];\n\t\t\t\t\t\t!targetCnt.contains(layer.domElement) && targetCnt.appendChild(layer.domElement);\n\t\t\t\t\t}\n\n\t\t\t\t\twindow.Q3.scrollPositions = window.Q3.scrollPositions || [];\n\n\t\t\t\t\tlet el = layer.objects[0].domElement.children[0].children[0];\n\n\t\t\t\t\tif (!window.Q3.scrollPositions[layer.objects[0].uuid] && !layer.generalVisibility) {\n\t\t\t\t\t\tsetScrollPositions(el, layer.objects[0].startSlide, layer.objects[0].uuid);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst scrollPositions = window.Q3.scrollPositions[layer.objects[0].uuid];\n\t\t\t\t\tif (scrollPositions) {\n\t\t\t\t\t\tconst scrollTop = window.Q3.scrollPositions[layer.objects[0].uuid][window.Q3.slide];\n\n\t\t\t\t\t\tscrollTop !== -1 && !byScroll ? (el.scrollTop = scrollTop) : null;\n\t\t\t\t\t}\n\t\t\t\t} else if (\n\t\t\t\t\tlayer.objects &&\n\t\t\t\t\t(layer.objects[0] instanceof window.Q3.Picture ||\n\t\t\t\t\t\tlayer.objects[0] instanceof window.Q3.Button ||\n\t\t\t\t\t\tlayer.objects[0] instanceof window.Q3.Iframe) &&\n\t\t\t\t\t!window.Q3.editMode\n\t\t\t\t) {\n\t\t\t\t\tthis.letterbox.appendChild(layer.domElement);\n\t\t\t\t} else {\n\t\t\t\t\tthis.container.appendChild(layer.domElement);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t//browser DOM rendering efficiency here ?\n\n\t\t/*  while ( this.container.lastChild ) this.container.removeChild( this.container.lastChild );\n      this.stack.forEach( layer => { this.container.appendChild( layer.domElement ) } );*/\n\t}\n\n\trender() {\n\t\tlet w = RenderManager.domElement.width;\n\t\tlet h = RenderManager.domElement.height - 55;\n\n\t\t// if (w<=768 && !window.Q3.editMode) {\n\t\t//   h = h - 50;\n\t\t// }\n\n\t\tthis.graph.forEach(layer => layer.render(w / window.devicePixelRatio, h / window.devicePixelRatio));\n\n\t\tthis.occludeObjects();\n\t}\n\n\toccludeObjects() {\n\t\t//todo :\n\t\t//before checking what object occludes what other object\n\t\t//check if objects are occluded by other stuff\n\t\t//which means first cpu calculcation of distance and comparing to depthbbuffer.\n\n\t\tif (!window.Q3.depthPass || window.Q3.noFragDepth || window.Q3.noDepthTex) return;\n\n\t\t//1. get camera distance and depth value\n\t\tthis.attachedObjects.forEach(object => {\n\t\t\tif (object instanceof window.Q3.Text) {\n\t\t\t\tconst x = parseInt(object.domElement.getAttribute('x')),\n\t\t\t\t\ty = parseInt(object.domElement.getAttribute('y')),\n\t\t\t\t\twidth = parseInt(object.textElement.style.width),\n\t\t\t\t\theight = parseInt(object.textElement.style.height),\n\t\t\t\t\tcx = x + width / 2,\n\t\t\t\t\tcy = y + height / 2;\n\n\t\t\t\t//Units = far-near distance\n\t\t\t\t//1. depth value at the position of the target ( to check object occlusion)\n\t\t\t\tobject.depthValue = window.Q3.depthPass.getDepthRatio(cx, cy);\n\n\t\t\t\t//2. camera distance of the target\n\t\t\t\tobject.camDist =\n\t\t\t\t\t(object.target.position\n\t\t\t\t\t\t.clone()\n\t\t\t\t\t\t.sub(window.Q3.camera.position)\n\t\t\t\t\t\t.length() -\n\t\t\t\t\t\twindow.Q3.camera.near) /\n\t\t\t\t\t(window.Q3.camera.far - window.Q3.camera.near);\n\t\t\t} else if (object instanceof window.Q3.Picture) {\n\t\t\t\tconst x = parseInt(object.domElement.getAttribute('x')),\n\t\t\t\t\ty = parseInt(object.domElement.getAttribute('y')),\n\t\t\t\t\twidth = parseInt(object.pictureElement.style.width),\n\t\t\t\t\theight = parseInt(object.pictureElement.style.height) || 0.5,\n\t\t\t\t\tcx = x + width / 2,\n\t\t\t\t\tcy = y + height / 2;\n\n\t\t\t\t//Units = far-near distance\n\t\t\t\t//1. depth value at the position of the target ( to check object occlusion)\n\t\t\t\tobject.depthValue = window.Q3.depthPass.getDepthRatio(cx, cy);\n\n\t\t\t\t//2. camera distance of the target\n\t\t\t\tobject.camDist =\n\t\t\t\t\t(object.target.position\n\t\t\t\t\t\t.clone()\n\t\t\t\t\t\t.sub(window.Q3.camera.position)\n\t\t\t\t\t\t.length() -\n\t\t\t\t\t\twindow.Q3.camera.near) /\n\t\t\t\t\t(window.Q3.camera.far - window.Q3.camera.near);\n\t\t\t}\n\t\t});\n\n\t\t//2. sort on camera distance\n\t\tthis.attachedObjects.sort((a, b) => {\n\t\t\treturn a.camDist < b.camDist ? -1 : a.camDist > b.camDist ? 1 : 0;\n\t\t});\n\n\t\t//3. object occlusion\n\t\tconst visibleObjects = [];\n\n\t\tthis.attachedObjects.forEach(object => {\n\t\t\tif (!object.depthOccluded) {\n\t\t\t\tobject.show();\n\t\t\t\tvisibleObjects.push(object);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (object.depthValue < object.camDist) {\n\t\t\t\tobject.hide();\n\t\t\t} else {\n\t\t\t\tobject.show();\n\t\t\t\tvisibleObjects.push(object);\n\t\t\t}\n\t\t});\n\n\t\t//4. occlude by checking previous objects\n\t\tvisibleObjects.forEach((object, i) => {\n\t\t\tif (i === 0) return object.show();\n\n\t\t\tif (!object.elementsOccluded) return object.show();\n\n\t\t\tfor (let j = 0; j < i; j++) {\n\t\t\t\tif (areColliding(this.attachedObjects[j], object)) {\n\t\t\t\t\treturn object.hide();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tobject.show();\n\t\t});\n\t}\n}\n\nfunction areColliding(objectA, objectB) {\n\tconst xA = parseInt(objectA.domElement.getAttribute('x')),\n\t\tyA = parseInt(objectA.domElement.getAttribute('y')),\n\t\twidthA = parseInt(objectA.textElement.style.width),\n\t\theightA = parseInt(objectA.textElement.style.height),\n\t\txB = parseInt(objectB.domElement.getAttribute('x')),\n\t\tyB = parseInt(objectB.domElement.getAttribute('y')),\n\t\twidthB = parseInt(objectB.textElement.style.width),\n\t\theightB = parseInt(objectB.textElement.style.height);\n\n\tlet areCollidingHorizontally = false,\n\t\tareCollidingVertically = false;\n\n\t//horizontal checks\n\tif (xA > xB) areCollidingHorizontally = xB + widthB > xA;\n\telse if (xA < xB) areCollidingHorizontally = xA + widthA > xB;\n\n\t//vertical checks\n\tif (yA > yB) areCollidingVertically = yB + heightB > yA;\n\telse if (yA < yB) areCollidingVertically = yA + heightA > yB;\n\n\treturn areCollidingHorizontally && areCollidingVertically;\n}\n\nfunction setScrollPositions(el, startSlide, uuid) {\n\tlet scrollPositions = [];\n\tfor (let i in window.Q3.data.slides) {\n\t\tscrollPositions[i] = -1;\n\t}\n\n\tscrollPositions[startSlide] = 0;\n\n\tconst textElementTop = el.getBoundingClientRect().top;\n\n\tel.innerHTML += '<hr class=\"horizontal-marker viewer\"></hr>';\n\tconst markers = $(el).find('.horizontal-marker');\n\tlet slide = startSlide + 1;\n\tlet shouldSet = true;\n\tif (markers.length > 1) {\n\t\tfor (var i = 0; i < markers.length; i++) {\n\t\t\t//this.options.scrollPositions[$(markers[i]).attr('data-slide')] = Math.round(markers[i].getBoundingClientRect().top - textElementTop);\n\t\t\tconsole.log(markers[i].getBoundingClientRect().top);\n\t\t\tif (markers[i].getBoundingClientRect().top === 0) shouldSet = false;\n\t\t\tscrollPositions[slide++] = Math.round(markers[i].getBoundingClientRect().top - textElementTop);\n\t\t}\n\t}\n\twindow.Q3.scrollPositions = window.Q3.scrollPositions || [];\n\tif (shouldSet) window.Q3.scrollPositions[uuid] = scrollPositions;\n}\n\n// WEBPACK FOOTER //\n// ./src/Q3/layers/LayersManager.js\n"]},"metadata":{},"sourceType":"module"}